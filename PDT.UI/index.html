<head>
    <title>HTMX and Tailwind Application</title>
    <link href="dist/style.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js"></script>
</head>
<body class="bg-gray-100 p-10 grid grid-cols-1 gap-6">
    <!-- HTMX Popup for Meilisearch Filter Syntax -->
<div id="filter-popup" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 h-full w-full hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full">
      <h2 class="text-xl font-bold mb-4">Filter Syntax</h2>
      <div class="text-sm space-y-2">
        <!-- Equal to -->
        <p><strong>=</strong> Equal to: <code>path = '/path/to/file'</code></p>
        
        <!-- Not equal -->
        <p><strong>!=</strong> Not equal to: <code>extension != 'pdf'</code></p>
        
        <!-- Greater than / Less than -->
        <p><strong>></strong> Greater than: <code>size > 100</code></p>
        <p><strong><</strong> Less than: <code>created < '2022-01-01'</code></p>
        <p><strong>>=</strong> Greater than or equal to: <code>updated >= '2022-01-01 00:00:00'</code></p>
        <p><strong><=</strong> Less than or equal to: <code>scanned <= '2022-01-31'</code></p>
        
        <!-- Range -->
        <p><strong>[A TO B]</strong> Range: <code>size [10 TO 100]</code></p>
        
        <!-- Logical AND / OR -->
        <p><strong>AND</strong> Combine multiple conditions: <code>extension = 'jpg' AND size > 500</code></p>
        <p><strong>OR</strong> Either condition: <code>extension = 'png' OR extension = 'gif'</code></p>
        
        <!-- Grouping with parentheses -->
        <p><strong>Parentheses</strong> Group filters: <code>(extension = 'pdf' OR extension = 'doc') AND size < 500</code></p>
          </div>
      <!-- Close Button -->
      <div class="mt-4 flex justify-end">
        <button hx-get="#" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Close</button>
      </div>
    </div>
  </div>

    <div class="w-full mx-auto bg-white shadow-md p-8">
        <div class="flex flex-row items-center">
            <h1 class="text-2xl font-bold mb-6 flex-grow">Document Query Menu</h1>
            <button class="px-4 mb-4 mr-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="togglePopup()">Query Syntax</button>
            <select id="indexSelect" name="indexSelect" class="border p-2 w-2/8 mb-4">
                <option value="" disabled selected>Select an Repository</option>
            </select>
        </div>

        <!-- Form to submit -->
        <div class="form-group">
            <input class="form-control border p-2 w-full mb-4" type="search" 
                   name="filter" id="filter" placeholder="Begin typing to start your query..." 
                   hx-get="http://localhost:7700/indexes/:indexSelect/documents" 
                   hx-headers='{"Authorization": "Bearer kToLWXAc2Qvm7yamYuBNE5DyYFka4koTo0ebGr7nBYo"}' 
                   hx-trigger="input changed delay:500ms, search" 
                   hx-ext="parse-json" 
                   hx-target="#search-results" 
                   hx-indicator=".htmx-indicator">
        </div>
        
        <table class="table-auto w-full">
            <thead>
                <tr>
                    <th class="px-4 py-2">Path</th>
                    <th class="px-4 py-2">Name</th>
                    <th class="px-2 py-2">Extension</th>
                    <th class="px-3 py-2">Size</th>
                    <th class="px-4 py-2">Created</th>
                    <th class="px-4 py-2">Updated</th>
                    <th class="px-4 py-2">Accessed</th>
                    <th class="px-4 py-2">Scanned</th>
                </tr>
            </thead>
            <tbody id="search-results" name="search-results">
            </tbody>
        </table>
    
        </div>
        
        <div class="htmx-indicator">
            Loading...
        </div>

    </div>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js"></script>
    <script>

        window.onload = function() {
            fetch('http://localhost:7700/indexes', {
                headers: {
                    'Authorization': 'Bearer kToLWXAc2Qvm7yamYuBNE5DyYFka4koTo0ebGr7nBYo'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                const select = document.getElementById('indexSelect');
                data.results.forEach(index => {
                    if (index.uid !== 'pdt') {
                        
                        const option = document.createElement('option');
                        option.value = index.uid;
                        option.text = index.uid;
                        select.add(option);
                    }
                });
            });

            document.getElementById('indexSelect').addEventListener('change', function() {
                const selectValue = this.value;
                const searchInput = document.getElementById('filter');
                searchInput.setAttribute('hx-get', `http://localhost:7700/indexes/${selectValue}/documents`);
                htmx.process(searchInput);
            });

            htmx.defineExtension('parse-json', {
                onEvent: function(name, evt) {
                    console.log("TESTSETSETSETSE")
                    if (name === 'htmx:afterRequest') {
                        const response = evt.detail.xhr.response;
                        const target = evt.detail.target;
                        const data = JSON.parse(response);
                        const tbody = document.getElementById(target);
                        tbody.innerHTML = '';
                        data.results.forEach(result => {
                            const row = document.createElement('tr');
                            const pathCell = document.createElement('td');
                            pathCell.textContent = result.path;
                            row.appendChild(pathCell);
                            const nameCell = document.createElement('td');
                            nameCell.textContent = result.name;
                            row.appendChild(nameCell);
                            const extensionCell = document.createElement('td');
                            extensionCell.textContent = result.extension;
                            row.appendChild(extensionCell);
                            const sizeCell = document.createElement('td');
                            sizeCell.textContent = result.size;
                            row.appendChild(sizeCell);
                            const createdCell = document.createElement('td');
                            createdCell.textContent = result.created;
                            row.appendChild(createdCell);
                            const updatedCell = document.createElement('td');
                            updatedCell.textContent = result.updated;
                            row.appendChild(updatedCell);
                            const accessedCell = document.createElement('td');
                            accessedCell.textContent = result.accessed;
                            row.appendChild(accessedCell);
                            const scannedCell = document.createElement('td');
                            scannedCell.textContent = result.scanned;
                            row.appendChild(scannedCell);
                            tbody.appendChild(row);
                        });
                    }
                }
            });
        };
    </script>
    </div>

    <script>

function togglePopup() {
    const popup = document.getElementById('filter-popup');
    popup.classList.toggle('hidden');
  }
  
  document.querySelector('button').addEventListener('click', togglePopup);
    document.getElementById('indexSelect').addEventListener('change', function() {
        const selectValue = this.value;
        const searchInput = document.getElementById('filter');
        searchInput.setAttribute('hx-get', `http://localhost:7700/indexes/${selectValue}/documents`);
        htmx.process(searchInput);
    });

        window.onload = function() {
            fetch('http://localhost:7700/indexes', {
                headers: {
                    'Authorization': 'Bearer kToLWXAc2Qvm7yamYuBNE5DyYFka4koTo0ebGr7nBYo'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                const select = document.getElementById('indexSelect');
                data.results.forEach(index => {
                    if (index.uid !== 'pdt') {
                        
                        const option = document.createElement('option');
                        option.value = index.uid;
                        option.text = index.uid;
                        select.add(option);
                    }
                });
            });
        };
    </script>
</body>